<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Modal Switch Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1f2937;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background-color: #374151;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .button {
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .success { color: #10b981; background-color: #064e3b; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .error { color: #ef4444; background-color: #450a0a; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .warning { color: #f59e0b; background-color: #451a03; padding: 10px; border-radius: 5px; margin: 5px 0; }
        .info { color: #3b82f6; background-color: #0c1e2e; padding: 10px; border-radius: 5px; margin: 5px 0; }
        
        /* Modal Simulation Styles */
        .modal-simulation {
            background-color: #4b5563;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #d1d5db;
        }
        .form-select {
            width: 100%;
            padding: 8px 12px;
            background-color: #374151;
            color: white;
            border: 1px solid #6b7280;
            border-radius: 4px;
        }
        .debug-info {
            background-color: #111827;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Device Modal Switch Connection Test</h1>
        
        <div class="section">
            <h2>Step 1: Setup Test Data</h2>
            <button class="button" onclick="setupTestData()">Setup Test Data</button>
            <button class="button" onclick="clearData()">Clear Data</button>
            <div id="setup-results"></div>
        </div>

        <div class="section">
            <h2>Step 2: Simulate Device Modal</h2>
            <button class="button" onclick="simulateDeviceModal()">Simulate Opening Device Modal</button>
            <div id="modal-simulation"></div>
        </div>

        <div class="section">
            <h2>Step 3: Test Switch Connection Save</h2>
            <button class="button" onclick="testSwitchConnection()">Test Switch Connection Save</button>
            <div id="save-results"></div>
        </div>

        <div class="section">
            <h2>Step 4: Verify Data Persistence</h2>
            <button class="button" onclick="verifyPersistence()">Verify Data Persistence</button>
            <div id="persistence-results"></div>
        </div>

        <div class="section">
            <h2>Debug Information</h2>
            <div id="debug-info"></div>
        </div>
    </div>

    <script>
        let testDeviceData = null;
        let simulatedDevice = null;

        function setupTestData() {
            const resultsDiv = document.getElementById('setup-results');
            
            const testData = {
                "10.5.1.1": {
                    name: "Test Gateway",
                    networkRole: "Gateway",
                    category: "Gateway",
                    parentGateway: null,
                    parentSwitch: null,
                    connectedGateways: [],
                    connectedSwitches: [],
                    isMainGateway: true,
                    notes: [],
                    history: []
                },
                "10.5.1.10": {
                    name: "Test Core Switch",
                    networkRole: "Switch",
                    category: "Switch",
                    parentGateway: "10.5.1.1",
                    parentSwitch: null,
                    connectedGateways: ["10.5.1.1"],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "10.5.1.11": {
                    name: "Test Access Switch",
                    networkRole: "Switch",  
                    category: "Switch",
                    parentGateway: "10.5.1.1",
                    parentSwitch: null,
                    connectedGateways: ["10.5.1.1"],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "10.5.1.20": {
                    name: "Test Device",
                    networkRole: null, // Regular device
                    category: "Workstation",
                    parentGateway: null,
                    parentSwitch: null, // Not connected yet
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                }
            };

            localStorage.setItem("customDeviceProperties", JSON.stringify(testData));
            testDeviceData = testData;
            
            resultsDiv.innerHTML = `
                <div class="success">✅ Test data setup complete!</div>
                <div class="info">Created test environment with:
                    <ul>
                        <li>1 Gateway (10.5.1.1)</li>
                        <li>2 Switches (10.5.1.10, 10.5.1.11)</li>
                        <li>1 Test device (10.5.1.20) ready for connection</li>
                    </ul>
                </div>
            `;

            updateDebugInfo();
        }

        function simulateDeviceModal() {
            const modalDiv = document.getElementById('modal-simulation');
            
            if (!testDeviceData) {
                modalDiv.innerHTML = '<div class="error">❌ Please setup test data first</div>';
                return;
            }

            // Simulate getting the device data (like what happens when modal opens)
            const device = testDeviceData["10.5.1.20"];
            simulatedDevice = { ...device, ip: "10.5.1.20" };

            // Get available switches (simulate the modal logic)
            const availableSwitches = Object.entries(testDeviceData)
                .filter(([ip, props]) => 
                    (props.networkRole === 'Switch' || props.networkRole === 'switch') && ip !== simulatedDevice.ip
                );

            let modalHtml = `
                <div class="modal-simulation">
                    <h3>Simulated Device Modal: ${simulatedDevice.name} (${simulatedDevice.ip})</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Device Type:</label>
                        <div class="debug-info">networkRole: ${simulatedDevice.networkRole || 'null (regular device)'}</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Connected to Switch:</label>
                        <select class="form-select" id="switch-dropdown" onchange="updateSwitchConnection(this.value)">
                            <option value="">Not connected to a switch</option>
            `;

            availableSwitches.forEach(([ip, props]) => {
                const selected = simulatedDevice.parentSwitch === ip ? 'selected' : '';
                modalHtml += `<option value="${ip}" ${selected}>${props.name || ip} (Switch)</option>`;
            });

            modalHtml += `
                        </select>
                        <div class="debug-info">
                            Current parentSwitch: ${simulatedDevice.parentSwitch || 'null'}<br>
                            Available switches: ${availableSwitches.length}<br>
                            Switch options: ${availableSwitches.map(([ip, props]) => `${props.name || ip} (${ip})`).join(', ')}
                        </div>
                    </div>

                    <div class="form-group">
                        <button class="button" onclick="saveSimulatedDevice()">Save Device</button>
                    </div>
                </div>
            `;

            modalDiv.innerHTML = modalHtml;

            if (availableSwitches.length === 0) {
                modalDiv.innerHTML += '<div class="error">❌ No switches available for connection!</div>';
            } else {
                modalDiv.innerHTML += `<div class="success">✅ Modal simulation shows ${availableSwitches.length} available switches</div>`;
            }
        }

        function updateSwitchConnection(selectedValue) {
            if (!simulatedDevice) return;
            
            console.log(`Updating simulated device switch connection to: "${selectedValue}"`);
            
            simulatedDevice.parentSwitch = selectedValue === "" ? null : selectedValue;
            simulatedDevice.parentGateway = null; // Clear gateway connection when connecting to switch
            
            const debugDiv = document.querySelector('.debug-info');
            if (debugDiv) {
                debugDiv.innerHTML = `
                    Current parentSwitch: ${simulatedDevice.parentSwitch || 'null'}<br>
                    parentGateway: ${simulatedDevice.parentGateway || 'null'}<br>
                    Last update: ${new Date().toLocaleTimeString()}
                `;
            }
        }

        function saveSimulatedDevice() {
            const resultsDiv = document.getElementById('save-results');
            
            if (!simulatedDevice) {
                resultsDiv.innerHTML = '<div class="error">❌ No simulated device to save</div>';
                return;
            }

            try {
                // Simulate the updateDeviceProperties function
                const storedProps = localStorage.getItem("customDeviceProperties") || "{}";
                const customProps = JSON.parse(storedProps);

                // Update the device properties (simulate the actual save logic)
                customProps[simulatedDevice.ip] = {
                    ...customProps[simulatedDevice.ip],
                    name: simulatedDevice.name,
                    category: simulatedDevice.category,
                    networkRole: simulatedDevice.networkRole,
                    parentSwitch: simulatedDevice.parentSwitch || null,
                    parentGateway: simulatedDevice.parentGateway || null,
                    connectedGateways: simulatedDevice.connectedGateways || [],
                    connectedSwitches: simulatedDevice.connectedSwitches || [],
                    notes: simulatedDevice.notes || []
                };

                // Save back to localStorage
                localStorage.setItem("customDeviceProperties", JSON.stringify(customProps));

                resultsDiv.innerHTML = `
                    <div class="success">✅ Device saved successfully!</div>
                    <div class="info">Saved device ${simulatedDevice.name} with parentSwitch: ${simulatedDevice.parentSwitch || 'null'}</div>
                `;

                // Update test data and debug info
                testDeviceData = customProps;
                updateDebugInfo();

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Error saving device: ${error.message}</div>`;
                console.error('Save error:', error);
            }
        }

        function testSwitchConnection() {
            const resultsDiv = document.getElementById('save-results');
            
            if (!testDeviceData) {
                resultsDiv.innerHTML = '<div class="error">❌ Please setup test data first</div>';
                return;
            }

            try {
                // Test connecting the device to the first available switch
                const device = { ...testDeviceData["10.5.1.20"], ip: "10.5.1.20" };
                const targetSwitch = "10.5.1.10"; // Core Switch

                // Simulate the connection
                device.parentSwitch = targetSwitch;
                device.parentGateway = null;

                // Save using the same logic as the actual application
                const customProps = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                customProps[device.ip] = {
                    ...customProps[device.ip],
                    parentSwitch: device.parentSwitch,
                    parentGateway: device.parentGateway
                };
                localStorage.setItem("customDeviceProperties", JSON.stringify(customProps));

                // Verify the save worked
                const savedData = JSON.parse(localStorage.getItem("customDeviceProperties"));
                const savedDevice = savedData["10.5.1.20"];

                if (savedDevice.parentSwitch === targetSwitch) {
                    resultsDiv.innerHTML = `
                        <div class="success">✅ Switch connection test PASSED!</div>
                        <div class="info">Successfully connected ${device.name} to ${testDeviceData[targetSwitch].name}</div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="error">❌ Switch connection test FAILED!</div>
                        <div class="error">Expected: ${targetSwitch}, Got: ${savedDevice.parentSwitch}</div>
                    `;
                }

                testDeviceData = savedData;
                updateDebugInfo();

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Test error: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        }

        function verifyPersistence() {
            const resultsDiv = document.getElementById('persistence-results');
            
            try {
                // Reload data from localStorage to simulate page refresh
                const reloadedData = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                const testDevice = reloadedData["10.5.1.20"];

                let results = '';
                let passed = 0;
                let failed = 0;

                // Test 1: Verify device exists
                if (testDevice) {
                    results += '<div class="success">✅ Test device found after reload</div>';
                    passed++;
                } else {
                    results += '<div class="error">❌ Test device not found after reload</div>';
                    failed++;
                }

                // Test 2: Verify switch connection persisted
                if (testDevice && testDevice.parentSwitch) {
                    results += `<div class="success">✅ Switch connection persisted: ${testDevice.parentSwitch}</div>`;
                    passed++;
                } else {
                    results += '<div class="warning">⚠️ No switch connection found (may be expected)</div>';
                }

                // Test 3: Verify connected switch exists
                if (testDevice && testDevice.parentSwitch && reloadedData[testDevice.parentSwitch]) {
                    const connectedSwitch = reloadedData[testDevice.parentSwitch];
                    results += `<div class="success">✅ Connected switch exists: ${connectedSwitch.name}</div>`;
                    passed++;
                } else if (testDevice && testDevice.parentSwitch) {
                    results += `<div class="error">❌ Connected switch ${testDevice.parentSwitch} does not exist</div>`;
                    failed++;
                }

                // Test 4: Verify switch has correct role
                if (testDevice && testDevice.parentSwitch && reloadedData[testDevice.parentSwitch]) {
                    const connectedSwitch = reloadedData[testDevice.parentSwitch];
                    if (connectedSwitch.networkRole === 'Switch' || connectedSwitch.networkRole === 'switch') {
                        results += '<div class="success">✅ Connected device has correct Switch role</div>';
                        passed++;
                    } else {
                        results += `<div class="error">❌ Connected device has incorrect role: ${connectedSwitch.networkRole}</div>`;
                        failed++;
                    }
                }

                results += `<div class="info">Persistence tests: ${passed} passed, ${failed} failed</div>`;
                resultsDiv.innerHTML = results;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Verification error: ${error.message}</div>`;
                console.error('Verification error:', error);
            }
        }

        function updateDebugInfo() {
            const debugDiv = document.getElementById('debug-info');
            
            try {
                const currentData = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                
                let debugHtml = '<h4>Current localStorage Data:</h4>';
                debugHtml += '<div class="debug-info">';
                debugHtml += JSON.stringify(currentData, null, 2);
                debugHtml += '</div>';

                // Summary
                const devices = Object.keys(currentData).length;
                const switches = Object.values(currentData).filter(d => d.networkRole === 'Switch' || d.networkRole === 'switch').length;
                const connected = Object.values(currentData).filter(d => d.parentSwitch || d.parentGateway).length;

                debugHtml += `
                    <div class="info">
                        <strong>Summary:</strong> ${devices} total devices, ${switches} switches, ${connected} devices with connections
                    </div>
                `;

                debugDiv.innerHTML = debugHtml;

            } catch (error) {
                debugDiv.innerHTML = `<div class="error">Error updating debug info: ${error.message}</div>`;
            }
        }

        function clearData() {
            localStorage.removeItem("customDeviceProperties");
            testDeviceData = null;
            simulatedDevice = null;
            document.getElementById('setup-results').innerHTML = '<div class="success">Data cleared!</div>';
            document.getElementById('modal-simulation').innerHTML = '';
            document.getElementById('save-results').innerHTML = '';
            document.getElementById('persistence-results').innerHTML = '';
            updateDebugInfo();
        }

        // Initialize
        window.onload = function() {
            updateDebugInfo();
        };
    </script>
</body>
</html>
