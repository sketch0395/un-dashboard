<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device History Debug Test</title>
</head>
<body>
    <h1>Device History Debug Test</h1>
    <div id="test-results"></div>
    
    <script>
        // Test to see what's actually happening with device history
        function debugDeviceHistory() {
            const resultsDiv = document.getElementById('test-results');
            let html = '<h2>Device History Debug Results:</h2>';
            
            // Get current localStorage state
            const customProps = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
            html += '<h3>Current localStorage State:</h3>';
            html += '<pre>' + JSON.stringify(customProps, null, 2) + '</pre>';
            
            // Create a test device update
            const testDeviceIP = "192.168.1.100";
            const existingDevice = customProps[testDeviceIP] || {};
            
            // Simulate updating device properties
            const updatedDevice = {
                ip: testDeviceIP,
                name: "Test Device Updated " + new Date().toLocaleTimeString(),
                category: "Server",
                networkRole: "device",
                history: [
                    ...(existingDevice.history || []),
                    {
                        timestamp: new Date().toISOString(),
                        changes: {
                            name: "Test Device Updated " + new Date().toLocaleTimeString(),
                            category: "Server"
                        }
                    }
                ]
            };
            
            // Update localStorage
            const updatedCustomProps = {
                ...customProps,
                [testDeviceIP]: updatedDevice
            };
            
            localStorage.setItem("customDeviceProperties", JSON.stringify(updatedCustomProps));
            
            // Verify the update
            const verifyProps = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
            const verifyDevice = verifyProps[testDeviceIP];
            
            html += '<h3>Test Update Results:</h3>';
            html += '<p><strong>Device IP:</strong> ' + testDeviceIP + '</p>';
            html += '<p><strong>Device Name:</strong> ' + (verifyDevice?.name || 'Not found') + '</p>';
            html += '<p><strong>History Entries:</strong> ' + (verifyDevice?.history?.length || 0) + '</p>';
            
            if (verifyDevice?.history && verifyDevice.history.length > 0) {
                html += '<h4>Latest History Entry:</h4>';
                html += '<pre>' + JSON.stringify(verifyDevice.history[verifyDevice.history.length - 1], null, 2) + '</pre>';
            }
            
            html += '<h3>Updated localStorage State:</h3>';
            html += '<pre>' + JSON.stringify(verifyProps, null, 2) + '</pre>';
            
            resultsDiv.innerHTML = html;
        }
        
        // Run test when page loads
        window.addEventListener('load', debugDeviceHistory);
    </script>
</body>
</html>
