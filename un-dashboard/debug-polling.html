<!DOCTYPE html>
<html>
<head>
    <title>Device Management Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .log { background: #2a2a2a; padding: 10px; margin: 5px 0; border-radius: 5px; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .info { border-left: 4px solid #2196F3; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Device Management & Polling Debug</h1>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <button onclick="addTestDevices()">Add Test Devices</button>
    <button onclick="testSocketConnection()">Test Socket Connection</button>
    <button onclick="testManualPoll()">Manual Poll Test</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="output"></div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const output = document.getElementById('output');
        let socket = null;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
            console.log(message);
            
            // Auto-scroll to bottom
            output.scrollTop = output.scrollHeight;
        }
        
        function clearLogs() {
            output.innerHTML = '';
        }
        
        function checkLocalStorage() {
            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                const scanHistory = JSON.parse(localStorage.getItem("scanHistory") || "[]");
                
                log(`Found ${Object.keys(devices).length} devices in customDeviceProperties`, 'success');
                log(`Found ${scanHistory.length} scan history entries`, 'success');
                
                Object.entries(devices).forEach(([ip, props]) => {
                    log(`Device: ${ip} (${props.name || 'Unnamed'}) - Category: ${props.category || 'None'}`, 'info');
                });
                
                if (scanHistory.length > 0) {
                    const latest = scanHistory[0];
                    log(`Latest scan: ${latest.timestamp} - ${latest.deviceCount} devices`, 'info');
                }
                
            } catch (error) {
                log(`Error checking localStorage: ${error.message}`, 'error');
            }
        }
        
        function addTestDevices() {
            const testDevices = {
                "127.0.0.1": {
                    name: "Localhost",
                    category: "Development Server",
                    networkRole: null,
                    parentGateway: null,
                    parentSwitch: null,
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    isMainGateway: false,
                    history: []
                },
                "8.8.8.8": {
                    name: "Google DNS",
                    category: "Router",
                    networkRole: "gateway",
                    parentGateway: null,
                    parentSwitch: null,
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    isMainGateway: true,
                    history: []
                },
                "1.1.1.1": {
                    name: "Cloudflare DNS",
                    category: "Router",
                    networkRole: null,
                    parentGateway: null,
                    parentSwitch: null,
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    isMainGateway: false,
                    history: []
                }
            };
            
            const scanData = {
                "127.0.0.1": [{ ip: "127.0.0.1", status: "up", alive: true, latency: 1, hostname: "localhost", ports: ["22/tcp open ssh"], vendor: "Local", macInfo: { available: false } }],
                "8.8.8.8": [{ ip: "8.8.8.8", status: "up", alive: false, latency: null, hostname: "dns.google", ports: ["53/tcp open domain"], vendor: "Google", macInfo: { available: false } }],
                "1.1.1.1": [{ ip: "1.1.1.1", status: "up", alive: false, latency: null, hostname: "one.one.one.one", ports: ["53/tcp open domain"], vendor: "Cloudflare", macInfo: { available: false } }]
            };
            
            const scanHistory = [{
                timestamp: new Date().toISOString(),
                ipRange: "Test Data",
                data: scanData,
                deviceCount: 3
            }];
            
            localStorage.setItem("customDeviceProperties", JSON.stringify(testDevices));
            localStorage.setItem("scanHistory", JSON.stringify(scanHistory));
            
            log("Test devices and scan history added to localStorage", 'success');
            checkLocalStorage();
        }
        
        function testSocketConnection() {
            if (socket) {
                log("Disconnecting existing socket", 'info');
                socket.disconnect();
            }
            
            log("Connecting to Socket.IO server at http://localhost:4000", 'info');
            
            socket = io('http://localhost:4000', {
                transports: ['polling', 'websocket'],
                reconnectionAttempts: 3,
                reconnectionDelay: 1000,
                timeout: 10000
            });
            
            socket.on('connect', () => {
                log(`Connected to server! Socket ID: ${socket.id}`, 'success');
            });
            
            socket.on('disconnect', (reason) => {
                log(`Disconnected from server. Reason: ${reason}`, 'error');
            });
            
            socket.on('connect_error', (error) => {
                log(`Connection error: ${error.message}`, 'error');
            });
            
            socket.on('deviceStatusUpdate', (data) => {
                log(`Received device status update for ${data.results?.length || 0} devices`, 'success');
                if (data.results) {
                    data.results.forEach(result => {
                        const status = result.alive ? '✅ Online' : '❌ Offline';
                        const latency = result.latency ? ` (${result.latency}ms)` : '';
                        log(`${result.ip}: ${status}${latency}`, result.alive ? 'success' : 'error');
                    });
                }
            });
            
            socket.on('deviceStatusError', (error) => {
                log(`Device status error: ${error}`, 'error');
            });
        }
        
        function testManualPoll() {
            if (!socket || !socket.connected) {
                log("Socket not connected. Please test socket connection first.", 'error');
                return;
            }
            
            const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
            const deviceIPs = Object.keys(devices);
            
            if (deviceIPs.length === 0) {
                log("No devices found. Please add test devices first.", 'error');
                return;
            }
            
            log(`Starting manual poll for ${deviceIPs.length} devices: ${deviceIPs.join(', ')}`, 'info');
            
            socket.emit('pollDeviceStatus', {
                ips: deviceIPs,
                timestamp: new Date().toISOString()
            });
            
            log("Poll request sent to server", 'info');
        }
        
        // Auto-check localStorage on page load
        window.onload = () => {
            log("Page loaded - checking initial state", 'info');
            checkLocalStorage();
        };
    </script>
</body>
</html>
