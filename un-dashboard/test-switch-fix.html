<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Connection Fix Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1f2937;
            color: #fff;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .section {
            background-color: #374151;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .button {
            background-color: #3b82f6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #2563eb;
        }
        .fix-button {
            background-color: #10b981;
        }
        .fix-button:hover {
            background-color: #059669;
        }
        .error {
            color: #ef4444;
            background-color: #fef2f2;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #ef4444;
        }
        .success {
            color: #10b981;
            background-color: #f0fdf4;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #10b981;
        }
        .warning {
            color: #f59e0b;
            background-color: #fffbeb;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #f59e0b;
        }
        .info {
            color: #3b82f6;
            background-color: #eff6ff;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            border-left: 4px solid #3b82f6;
        }
        .device-list {
            margin: 10px 0;
        }
        .device-item {
            background-color: #4b5563;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        pre {
            background-color: #111827;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Switch Connection Fix Tool</h1>
        
        <div class="section">
            <h2>Quick Diagnostics</h2>
            <button class="button" onclick="runDiagnostics()">Run Diagnostics</button>
            <button class="button fix-button" onclick="fixAllIssues()">Auto-Fix All Issues</button>
            <button class="button" onclick="createTestEnvironment()">Create Test Environment</button>
            <button class="button" onclick="clearData()">Clear All Data</button>
            <div id="diagnostics-results"></div>
        </div>

        <div class="section">
            <h2>Current Network State</h2>
            <button class="button" onclick="showCurrentState()">Show Current State</button>
            <div id="current-state"></div>
        </div>

        <div class="section">
            <h2>Manual Testing</h2>
            <button class="button" onclick="openMainApp()">Open Main Application</button>
            <div class="info">
                <h3>Testing Steps:</h3>
                <ol>
                    <li>Open the main application</li>
                    <li>Go to Network Scan or Device Management page</li>
                    <li>Click on a device to edit it</li>
                    <li>Try setting the device type and connections</li>
                    <li>Save and verify the changes are persisted</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            return message;
        }

        function runDiagnostics() {
            const resultsDiv = document.getElementById('diagnostics-results');
            let results = '';
            let issues = [];

            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                const deviceCount = Object.keys(devices).length;

                results += `<div class="info">Found ${deviceCount} devices in storage</div>`;

                if (deviceCount === 0) {
                    results += '<div class="warning">No devices found in localStorage. Run "Create Test Environment" first.</div>';
                    resultsDiv.innerHTML = results;
                    return;
                }

                // Check for switches
                const switches = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'switch' || device.networkRole === 'Switch'
                );
                
                // Check for gateways
                const gateways = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'gateway' || device.networkRole === 'Gateway'
                );

                // Check regular devices
                const regularDevices = Object.entries(devices).filter(([_, device]) => 
                    !device.networkRole
                );

                results += `<div class="info">Network Summary: ${switches.length} switches, ${gateways.length} gateways, ${regularDevices.length} regular devices</div>`;

                // Issue 1: Check if switches have gateway connections
                switches.forEach(([ip, device]) => {
                    const hasGatewayConnection = 
                        (device.parentGateway && device.parentGateway.trim() !== '') ||
                        (Array.isArray(device.connectedGateways) && device.connectedGateways.length > 0);
                    
                    if (!hasGatewayConnection && gateways.length > 0) {
                        issues.push({
                            type: 'switch_no_gateway',
                            device: ip,
                            name: device.name || ip,
                            message: 'Switch has no gateway connection'
                        });
                    }
                });

                // Issue 2: Check if regular devices have switch connections
                regularDevices.forEach(([ip, device]) => {
                    const hasConnection = 
                        (device.parentSwitch && device.parentSwitch.trim() !== '') ||
                        (device.parentGateway && device.parentGateway.trim() !== '');
                    
                    if (!hasConnection) {
                        issues.push({
                            type: 'device_no_connection',
                            device: ip,
                            name: device.name || ip,
                            message: 'Device has no switch or gateway connection'
                        });
                    }
                });

                // Issue 3: Check for invalid references
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.parentSwitch && !devices[device.parentSwitch]) {
                        issues.push({
                            type: 'invalid_switch_ref',
                            device: ip,
                            name: device.name || ip,
                            message: `References non-existent switch: ${device.parentSwitch}`
                        });
                    }
                    
                    if (device.parentGateway && !devices[device.parentGateway]) {
                        issues.push({
                            type: 'invalid_gateway_ref',
                            device: ip,
                            name: device.name || ip,
                            message: `References non-existent gateway: ${device.parentGateway}`
                        });
                    }
                });

                // Display issues
                if (issues.length === 0) {
                    results += '<div class="success">‚úÖ No issues found! Switch connections appear to be working correctly.</div>';
                } else {
                    results += `<div class="error">‚ùå Found ${issues.length} issues:</div>`;
                    issues.forEach((issue, index) => {
                        results += `<div class="error">${index + 1}. ${issue.name} (${issue.device}): ${issue.message}</div>`;
                    });
                }

            } catch (error) {
                results += `<div class="error">Error during diagnostics: ${error.message}</div>`;
                console.error('Diagnostics error:', error);
            }

            resultsDiv.innerHTML = results;
        }

        function fixAllIssues() {
            const resultsDiv = document.getElementById('diagnostics-results');
            let results = '';
            let fixes = [];

            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");

                // Get available switches and gateways
                const switches = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'switch' || device.networkRole === 'Switch'
                );
                
                const gateways = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'gateway' || device.networkRole === 'Gateway'
                );

                // Fix 1: Connect switches to gateways
                if (gateways.length > 0) {
                    const primaryGateway = gateways[0];
                    
                    switches.forEach(([ip, device]) => {
                        const hasGatewayConnection = 
                            (device.parentGateway && device.parentGateway.trim() !== '') ||
                            (Array.isArray(device.connectedGateways) && device.connectedGateways.length > 0);
                        
                        if (!hasGatewayConnection) {
                            devices[ip] = {
                                ...device,
                                parentGateway: primaryGateway[0],
                                connectedGateways: [primaryGateway[0]]
                            };
                            fixes.push(`Connected switch ${device.name || ip} to gateway ${primaryGateway[1].name || primaryGateway[0]}`);
                        }
                    });
                }

                // Fix 2: Connect regular devices to switches (or gateways if no switches)
                const regularDevices = Object.entries(devices).filter(([_, device]) => !device.networkRole);
                
                if (switches.length > 0) {
                    const primarySwitch = switches[0];
                    
                    regularDevices.forEach(([ip, device]) => {
                        const hasConnection = 
                            (device.parentSwitch && device.parentSwitch.trim() !== '') ||
                            (device.parentGateway && device.parentGateway.trim() !== '');
                        
                        if (!hasConnection) {
                            devices[ip] = {
                                ...device,
                                parentSwitch: primarySwitch[0],
                                parentGateway: null // Clear gateway connection in favor of switch
                            };
                            fixes.push(`Connected device ${device.name || ip} to switch ${primarySwitch[1].name || primarySwitch[0]}`);
                        }
                    });
                } else if (gateways.length > 0) {
                    const primaryGateway = gateways[0];
                    
                    regularDevices.forEach(([ip, device]) => {
                        const hasConnection = device.parentGateway && device.parentGateway.trim() !== '';
                        
                        if (!hasConnection) {
                            devices[ip] = {
                                ...device,
                                parentGateway: primaryGateway[0],
                                parentSwitch: null
                            };
                            fixes.push(`Connected device ${device.name || ip} to gateway ${primaryGateway[1].name || primaryGateway[0]}`);
                        }
                    });
                }

                // Fix 3: Remove invalid references
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.parentSwitch && !devices[device.parentSwitch]) {
                        devices[ip] = { ...device, parentSwitch: null };
                        fixes.push(`Removed invalid switch reference for ${device.name || ip}`);
                    }
                    
                    if (device.parentGateway && !devices[device.parentGateway]) {
                        devices[ip] = { ...device, parentGateway: null };
                        fixes.push(`Removed invalid gateway reference for ${device.name || ip}`);
                    }
                });

                // Save fixes
                localStorage.setItem("customDeviceProperties", JSON.stringify(devices));

                if (fixes.length === 0) {
                    results += '<div class="info">No fixes needed - everything already working correctly!</div>';
                } else {
                    results += `<div class="success">‚úÖ Applied ${fixes.length} fixes:</div>`;
                    fixes.forEach((fix, index) => {
                        results += `<div class="success">${index + 1}. ${fix}</div>`;
                    });
                    results += '<div class="success">All fixes have been saved to localStorage!</div>';
                }

            } catch (error) {
                results += `<div class="error">Error during fixes: ${error.message}</div>`;
                console.error('Fix error:', error);
            }

            resultsDiv.innerHTML = results;
        }

        function createTestEnvironment() {
            const resultsDiv = document.getElementById('diagnostics-results');
            
            const testDevices = {
                "192.168.1.1": {
                    name: "Main Gateway",
                    networkRole: "Gateway",
                    category: "Gateway",
                    parentGateway: null,
                    parentSwitch: null,
                    connectedGateways: [],
                    connectedSwitches: [],
                    isMainGateway: true,
                    notes: [],
                    history: []
                },
                "192.168.1.10": {
                    name: "Core Switch",
                    networkRole: "Switch",
                    category: "Switch",
                    parentGateway: "192.168.1.1",
                    parentSwitch: null,
                    connectedGateways: ["192.168.1.1"],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "192.168.1.11": {
                    name: "Access Switch",
                    networkRole: "Switch",
                    category: "Switch",
                    parentGateway: "192.168.1.1",
                    parentSwitch: null,
                    connectedGateways: ["192.168.1.1"],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "192.168.1.20": {
                    name: "Workstation 1",
                    networkRole: null,
                    category: "Workstation",
                    parentGateway: null,
                    parentSwitch: "192.168.1.10",
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "192.168.1.21": {
                    name: "Workstation 2",
                    networkRole: null,
                    category: "Workstation",
                    parentGateway: null,
                    parentSwitch: "192.168.1.11",
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                },
                "192.168.1.30": {
                    name: "Server 1",
                    networkRole: null,
                    category: "Server",
                    parentGateway: null,
                    parentSwitch: "192.168.1.10",
                    connectedGateways: [],
                    connectedSwitches: [],
                    notes: [],
                    history: []
                }
            };

            localStorage.setItem("customDeviceProperties", JSON.stringify(testDevices));
            
            resultsDiv.innerHTML = `
                <div class="success">‚úÖ Test environment created successfully!</div>
                <div class="info">Created ${Object.keys(testDevices).length} test devices:
                    <ul>
                        <li>1 Gateway (Main Gateway)</li>
                        <li>2 Switches (Core Switch, Access Switch)</li>
                        <li>3 Regular devices (Workstations and Server)</li>
                    </ul>
                    All devices are properly connected with switch relationships.
                </div>
            `;
        }

        function showCurrentState() {
            const resultsDiv = document.getElementById('current-state');
            
            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                
                if (Object.keys(devices).length === 0) {
                    resultsDiv.innerHTML = '<div class="warning">No devices found in localStorage</div>';
                    return;
                }

                let html = '<h3>Current Network Topology:</h3>';
                
                // Show gateways
                const gateways = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'gateway' || device.networkRole === 'Gateway'
                );
                
                gateways.forEach(([ip, device]) => {
                    html += `
                        <div class="device-item">
                            <strong>üåê Gateway: ${device.name || ip}</strong> (${ip})
                            ${device.isMainGateway ? ' <span style="color: #10b981;">[MAIN]</span>' : ''}
                        </div>
                    `;
                    
                    // Show switches connected to this gateway
                    const connectedSwitches = Object.entries(devices).filter(([_, d]) => 
                        d.parentGateway === ip || 
                        (Array.isArray(d.connectedGateways) && d.connectedGateways.includes(ip))
                    );
                    
                    connectedSwitches.forEach(([switchIp, switchDevice]) => {
                        html += `
                            <div class="device-item" style="margin-left: 20px;">
                                <strong>üîå Switch: ${switchDevice.name || switchIp}</strong> (${switchIp})
                            </div>
                        `;
                        
                        // Show devices connected to this switch
                        const connectedDevices = Object.entries(devices).filter(([_, d]) => 
                            d.parentSwitch === switchIp
                        );
                        
                        connectedDevices.forEach(([deviceIp, dev]) => {
                            html += `
                                <div class="device-item" style="margin-left: 40px;">
                                    üíª Device: ${dev.name || deviceIp} (${deviceIp}) - ${dev.category || 'Unknown'}
                                </div>
                            `;
                        });
                    });
                });

                // Show orphaned devices
                const orphanedDevices = Object.entries(devices).filter(([_, device]) => 
                    !device.networkRole && 
                    (!device.parentSwitch || device.parentSwitch.trim() === '') && 
                    (!device.parentGateway || device.parentGateway.trim() === '')
                );
                
                if (orphanedDevices.length > 0) {
                    html += '<div class="device-item" style="color: #f59e0b;"><strong>‚ö†Ô∏è Orphaned Devices (no connections):</strong></div>';
                    orphanedDevices.forEach(([ip, device]) => {
                        html += `
                            <div class="device-item" style="margin-left: 20px; color: #f59e0b;">
                                üíª ${device.name || ip} (${ip}) - ${device.category || 'Unknown'}
                            </div>
                        `;
                    });
                }

                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error showing current state: ${error.message}</div>`;
                console.error('Show state error:', error);
            }
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all device data? This cannot be undone.')) {
                localStorage.removeItem("customDeviceProperties");
                localStorage.removeItem("scannedDevices");
                document.getElementById('diagnostics-results').innerHTML = '<div class="success">All device data cleared!</div>';
                document.getElementById('current-state').innerHTML = '';
            }
        }

        function openMainApp() {
            window.open('http://localhost:3000', '_blank');
        }

        // Run initial diagnostics on page load
        window.onload = function() {
            log('Switch Connection Fix Tool loaded');
            runDiagnostics();
        };
    </script>
</body>
</html>
