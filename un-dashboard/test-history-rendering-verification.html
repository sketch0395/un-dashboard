<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device History Rendering Verification Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #333;
            margin-top: 0;
        }
        .step {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007acc;
        }
        .result {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        .warning {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .error {
            background: #f8d7da;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .test-data {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Device History Rendering Verification Test</h1>
    <p>This test verifies that imported device history data renders correctly in the application interface.</p>

    <div class="test-section">
        <h2>Test Setup</h2>
        <div class="step">
            <strong>Step 1:</strong> Create test data with comprehensive device history
            <button onclick="createTestData()">Create Test Data</button>
            <div id="testDataStatus" class="status pending">Not Started</div>
        </div>
        <div class="step">
            <strong>Step 2:</strong> Export current data (if any exists)
            <button onclick="exportCurrentData()">Export Current Data</button>
            <div id="exportStatus" class="status pending">Not Started</div>
        </div>
        <div class="step">
            <strong>Step 3:</strong> Import test data with device history
            <button onclick="importTestData()">Import Test Data</button>
            <div id="importStatus" class="status pending">Not Started</div>
        </div>
    </div>

    <div class="test-section">
        <h2>History Rendering Verification</h2>
        <div class="step">
            <strong>Step 4:</strong> Verify data in localStorage
            <button onclick="verifyLocalStorage()">Check localStorage</button>
            <div id="localStorageStatus" class="status pending">Not Started</div>
            <div id="localStorageDetails" class="test-data" style="display: none;"></div>
        </div>
        <div class="step">
            <strong>Step 5:</strong> Open application and navigate to device management
            <button onclick="openApplication()">Open App</button>
            <div id="appStatus" class="status pending">Manual Verification Required</div>
        </div>
        <div class="step">
            <strong>Step 6:</strong> Manual verification checklist
            <div class="warning">
                <strong>Manual Steps Required:</strong>
                <ol>
                    <li>Open the application at <a href="http://localhost:3000" target="_blank">http://localhost:3000</a></li>
                    <li>Navigate to the Device Management page</li>
                    <li>Look for devices with names starting with "Test-Device-"</li>
                    <li>Click on a test device to open the device modal</li>
                    <li>Scroll down to the "Device History" section</li>
                    <li>Verify that history entries are displayed with:</li>
                    <ul>
                        <li>Proper timestamps</li>
                        <li>Expandable/collapsible entries</li>
                        <li>Change summaries showing what was modified</li>
                        <li>Detailed change information when expanded</li>
                        <li>All imported history entries visible</li>
                    </ul>
                    <li>Test multiple devices to ensure consistency</li>
                </ol>
                <button onclick="markManualVerificationComplete()">Mark Verification Complete</button>
                <div id="manualVerificationStatus" class="status pending">Pending Manual Check</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="testSummary">
            <div class="status pending">Test Not Started</div>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Data Details</h2>
        <div id="testDataDetails" class="test-data"></div>
    </div>

    <script>
        let testData = null;
        let originalData = null;

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
            updateSummary();
        }

        function updateSummary() {
            const statuses = document.querySelectorAll('.status');
            let passed = 0;
            let failed = 0;
            let pending = 0;

            statuses.forEach(status => {
                if (status.classList.contains('pass')) passed++;
                else if (status.classList.contains('fail')) failed++;
                else pending++;
            });

            const summary = document.getElementById('testSummary');
            summary.innerHTML = `
                <div class="status ${failed > 0 ? 'fail' : pending > 0 ? 'pending' : 'pass'}">
                    Passed: ${passed} | Failed: ${failed} | Pending: ${pending}
                </div>
            `;
        }

        function createTestData() {
            try {
                // Create comprehensive test data with multiple devices and extensive history
                testData = {
                    devices: {
                        "192.168.1.100": {
                            name: "Test-Device-Router-Main",
                            ip: "192.168.1.100",
                            category: "Network Infrastructure",
                            networkRole: "Router",
                            parentGateway: "",
                            parentSwitch: "",
                            connectedGateways: ["192.168.1.101"],
                            connectedSwitches: ["192.168.1.102"],
                            notes: "Main router with comprehensive history",
                            history: [
                                {
                                    timestamp: "2024-01-15T10:30:00.000Z",
                                    changes: {
                                        name: { old: "Unknown Device", new: "Test-Device-Router-Main" },
                                        category: { old: "Unknown", new: "Network Infrastructure" },
                                        networkRole: { old: "", new: "Router" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-20T14:15:00.000Z",
                                    changes: {
                                        connectedGateways: { old: [], new: ["192.168.1.101"] },
                                        notes: { old: "", new: "Added gateway connection" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-25T09:45:00.000Z",
                                    changes: {
                                        connectedSwitches: { old: [], new: ["192.168.1.102"] },
                                        notes: { old: "Added gateway connection", new: "Main router with comprehensive history" }
                                    }
                                }
                            ]
                        },
                        "192.168.1.101": {
                            name: "Test-Device-Gateway-Alpha",
                            ip: "192.168.1.101",
                            category: "Network Infrastructure",
                            networkRole: "Gateway",
                            parentGateway: "192.168.1.100",
                            parentSwitch: "",
                            connectedGateways: [],
                            connectedSwitches: ["192.168.1.103"],
                            notes: "Gateway device for testing history rendering",
                            history: [
                                {
                                    timestamp: "2024-01-16T11:20:00.000Z",
                                    changes: {
                                        name: { old: "Device-101", new: "Test-Device-Gateway-Alpha" },
                                        networkRole: { old: "", new: "Gateway" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-22T16:30:00.000Z",
                                    changes: {
                                        parentGateway: { old: "", new: "192.168.1.100" },
                                        notes: { old: "", new: "Connected to main router" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-28T13:10:00.000Z",
                                    changes: {
                                        connectedSwitches: { old: [], new: ["192.168.1.103"] },
                                        notes: { old: "Connected to main router", new: "Gateway device for testing history rendering" }
                                    }
                                }
                            ]
                        },
                        "192.168.1.102": {
                            name: "Test-Device-Switch-Primary",
                            ip: "192.168.1.102",
                            category: "Network Infrastructure",
                            networkRole: "Switch",
                            parentGateway: "192.168.1.100",
                            parentSwitch: "",
                            connectedGateways: [],
                            connectedSwitches: [],
                            notes: "Primary switch with history changes",
                            history: [
                                {
                                    timestamp: "2024-01-17T08:45:00.000Z",
                                    changes: {
                                        name: { old: "Switch-102", new: "Test-Device-Switch-Primary" },
                                        category: { old: "Unknown", new: "Network Infrastructure" },
                                        networkRole: { old: "", new: "Switch" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-23T12:20:00.000Z",
                                    changes: {
                                        parentGateway: { old: "", new: "192.168.1.100" }
                                    }
                                },
                                {
                                    timestamp: "2024-01-29T15:55:00.000Z",
                                    changes: {
                                        notes: { old: "", new: "Primary switch with history changes" }
                                    }
                                }
                            ]
                        }
                    },
                    customNames: {
                        // Additional history in customNames format (testing merged history)
                        "192.168.1.100": {
                            history: [
                                {
                                    timestamp: "2024-02-01T10:00:00.000Z",
                                    changes: {
                                        notes: { old: "Main router with comprehensive history", new: "Updated main router configuration" }
                                    }
                                }
                            ]
                        }
                    }
                };

                document.getElementById('testDataDetails').innerHTML = `
                    <h3>Generated Test Data:</h3>
                    <div class="code">${JSON.stringify(testData, null, 2)}</div>
                `;

                updateStatus('testDataStatus', 'pass', 'Test data created successfully');
            } catch (error) {
                updateStatus('testDataStatus', 'fail', `Error creating test data: ${error.message}`);
                console.error('Error creating test data:', error);
            }
        }

        function exportCurrentData() {
            try {
                // Store current data as backup
                const devices = JSON.parse(localStorage.getItem('scannedDevices') || '{}');
                const customNames = JSON.parse(localStorage.getItem('customDeviceNames') || '{}');
                
                originalData = { devices, customNames };
                
                const dataStr = JSON.stringify(originalData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'backup-before-history-test.json';
                link.click();
                
                URL.revokeObjectURL(url);
                
                updateStatus('exportStatus', 'pass', 'Current data exported as backup');
            } catch (error) {
                updateStatus('exportStatus', 'fail', `Export failed: ${error.message}`);
                console.error('Export error:', error);
            }
        }

        function importTestData() {
            if (!testData) {
                updateStatus('importStatus', 'fail', 'No test data available. Create test data first.');
                return;
            }

            try {
                // Clear existing data
                localStorage.removeItem('scannedDevices');
                localStorage.removeItem('customDeviceNames');

                // Import test data using the same logic as the actual import function
                const importedData = parseJSONImport(JSON.stringify(testData));
                
                // Store in localStorage
                localStorage.setItem('scannedDevices', JSON.stringify(importedData.devices));
                localStorage.setItem('customDeviceNames', JSON.stringify(importedData.customNames));

                updateStatus('importStatus', 'pass', 'Test data imported successfully');
            } catch (error) {
                updateStatus('importStatus', 'fail', `Import failed: ${error.message}`);
                console.error('Import error:', error);
            }
        }

        function verifyLocalStorage() {
            try {
                const devices = JSON.parse(localStorage.getItem('scannedDevices') || '{}');
                const customNames = JSON.parse(localStorage.getItem('customDeviceNames') || '{}');

                let deviceCount = Object.keys(devices).length;
                let historyCount = 0;
                let testDevices = 0;

                // Check for test devices and count history entries
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.name && device.name.startsWith('Test-Device-')) {
                        testDevices++;
                    }
                    if (device.history && Array.isArray(device.history)) {
                        historyCount += device.history.length;
                    }
                });

                const details = document.getElementById('localStorageDetails');
                details.style.display = 'block';
                details.innerHTML = `
                    <h4>localStorage Verification Results:</h4>
                    <ul>
                        <li><strong>Total devices:</strong> ${deviceCount}</li>
                        <li><strong>Test devices found:</strong> ${testDevices}</li>
                        <li><strong>Total history entries:</strong> ${historyCount}</li>
                        <li><strong>Custom names entries:</strong> ${Object.keys(customNames).length}</li>
                    </ul>
                    
                    <h4>Sample Device with History:</h4>
                    <div class="code">${JSON.stringify(devices['192.168.1.100'] || {}, null, 2)}</div>
                `;

                if (testDevices >= 3 && historyCount >= 9) {
                    updateStatus('localStorageStatus', 'pass', `Found ${testDevices} test devices with ${historyCount} history entries`);
                } else {
                    updateStatus('localStorageStatus', 'fail', `Expected 3+ test devices and 9+ history entries, found ${testDevices} devices and ${historyCount} entries`);
                }
            } catch (error) {
                updateStatus('localStorageStatus', 'fail', `Verification failed: ${error.message}`);
                console.error('Verification error:', error);
            }
        }

        function openApplication() {
            window.open('http://localhost:3000', '_blank');
            updateStatus('appStatus', 'pending', 'Application opened - manual verification required');
        }

        function markManualVerificationComplete() {
            const result = confirm(`Have you verified that:
1. Device history displays correctly in device modals?
2. History entries are expandable/collapsible?
3. Timestamps and change details are visible?
4. All imported history entries appear?
5. Multiple test devices show consistent history rendering?

Click OK if all checks passed, Cancel if any failed.`);

            if (result) {
                updateStatus('manualVerificationStatus', 'pass', 'Manual verification completed successfully');
            } else {
                updateStatus('manualVerificationStatus', 'fail', 'Manual verification failed - issues found');
            }
        }

        // Import parseJSONImport function (simplified version for testing)
        function parseJSONImport(jsonString) {
            const data = JSON.parse(jsonString);
            let devices = {};
            let customNames = {};

            // Handle devices from main devices object
            if (data.devices) {
                Object.entries(data.devices).forEach(([ip, device]) => {
                    devices[ip] = { ...device };
                    
                    // Ensure history is preserved
                    if (device.history && Array.isArray(device.history)) {
                        devices[ip].history = [...device.history];
                    }
                });
            }

            // Handle customNames object and merge any additional history
            if (data.customNames) {
                Object.entries(data.customNames).forEach(([ip, customData]) => {
                    if (!customNames[ip]) {
                        customNames[ip] = {};
                    }
                    
                    // Copy custom data
                    Object.assign(customNames[ip], customData);
                    
                    // Merge history if it exists
                    if (customData.history && Array.isArray(customData.history)) {
                        if (devices[ip]) {
                            if (!devices[ip].history) {
                                devices[ip].history = [];
                            }
                            devices[ip].history = [...devices[ip].history, ...customData.history];
                            
                            // Sort by timestamp
                            devices[ip].history.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        }
                    }
                });
            }

            return { devices, customNames };
        }

        // Initialize
        updateSummary();
    </script>
</body>
</html>
