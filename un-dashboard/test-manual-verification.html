<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Verification - Device History Import Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover { background-color: #0056b3; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .device-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .history-item {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Manual Verification: Device History Import Fix</h1>
        <p>This test verifies that the device history preservation fix is working correctly by testing real-world scenarios.</p>
        
        <div class="test-section info">
            <h3>üìã Test Instructions</h3>
            <ol>
                <li>Click "Generate Sample Export" to create realistic test data with device history</li>
                <li>Click "Test Import Process" to simulate importing the data</li>
                <li>Verify that device history is preserved in the results</li>
                <li>Use "Test Real Export File" to test with actual exported files</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üè≠ Generate Sample Export Data</h3>
            <button onclick="generateSampleExport()">Generate Sample Export</button>
            <button onclick="clearResults()">Clear Results</button>
            <div id="sampleExportData"></div>
        </div>

        <div class="test-section">
            <h3>üì• Test Import Process</h3>
            <button onclick="testImportProcess()">Test Import Process</button>
            <div id="importResults"></div>
        </div>

        <div class="test-section">
            <h3>üìÅ Test Real Export File</h3>
            <input type="file" id="fileInput" accept=".json" />
            <button onclick="testRealFile()">Test Real Export File</button>
            <div id="realFileResults"></div>
        </div>

        <div class="test-section">
            <h3>üìä Verification Results</h3>
            <div id="verificationResults"></div>
        </div>
    </div>

    <!-- Import the fixed utils -->
    <script src="/src/app/utils/exportImportUtils.js"></script>
    
    <script>
        let sampleExportData = null;
        let importedData = null;

        function generateSampleExport() {
            // Create realistic sample data with device history
            const currentTime = new Date().toISOString();
            const historyBaseTime = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(); // 7 days ago
            
            sampleExportData = {
                metadata: {
                    scanDate: currentTime,
                    ipRange: "192.168.1.0-255",
                    exportDate: currentTime,
                    version: "1.0"
                },
                devices: [
                    {
                        ip: "192.168.1.1",
                        hostname: "Router-Main",
                        mac: "00:11:22:33:44:55",
                        vendor: "Cisco",
                        openPorts: [80, 443, 22],
                        lastSeen: currentTime,
                        name: "Main Router",
                        category: "Network Infrastructure",
                        networkRole: "router",
                        isMainGateway: true,
                        parentGateway: null,
                        parentSwitch: null,
                        portCount: 24,
                        notes: ["Primary gateway", "Configured for DHCP"],
                        history: [
                            {
                                timestamp: historyBaseTime,
                                action: "device_discovered",
                                details: { hostname: "Router-Main", vendor: "Cisco" }
                            },
                            {
                                timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "name_changed",
                                details: { oldName: "192.168.1.1", newName: "Main Router" }
                            },
                            {
                                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "category_assigned",
                                details: { category: "Network Infrastructure" }
                            },
                            {
                                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "role_assigned",
                                details: { role: "router", isMainGateway: true }
                            }
                        ]
                    },
                    {
                        ip: "192.168.1.100",
                        hostname: "FileServer",
                        mac: "AA:BB:CC:DD:EE:FF",
                        vendor: "Dell",
                        openPorts: [21, 22, 80, 443, 445],
                        lastSeen: currentTime,
                        name: "Main File Server",
                        category: "Server",
                        networkRole: "server",
                        isMainGateway: false,
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        portCount: null,
                        notes: ["Primary file storage", "24/7 operation"],
                        history: [
                            {
                                timestamp: historyBaseTime,
                                action: "device_discovered",
                                details: { hostname: "FileServer", vendor: "Dell" }
                            },
                            {
                                timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "name_changed",
                                details: { oldName: "192.168.1.100", newName: "Main File Server" }
                            },
                            {
                                timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "category_assigned",
                                details: { category: "Server" }
                            }
                        ]
                    },
                    {
                        ip: "192.168.1.50",
                        hostname: "Switch-01",
                        mac: "12:34:56:78:90:AB",
                        vendor: "Netgear",
                        openPorts: [80, 443],
                        lastSeen: currentTime,
                        name: "Office Switch",
                        category: "Network Infrastructure",
                        networkRole: "switch",
                        isMainGateway: false,
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        portCount: 48,
                        notes: ["Main office switch"],
                        history: [
                            {
                                timestamp: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "device_discovered",
                                details: { hostname: "Switch-01", vendor: "Netgear" }
                            },
                            {
                                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "topology_updated",
                                details: { parentGateway: "192.168.1.1", portCount: 48 }
                            }
                        ]
                    }
                ],
                customNames: {
                    "192.168.1.1": {
                        name: "Main Router",
                        category: "Network Infrastructure",
                        notes: ["Primary gateway", "Configured for DHCP"],
                        networkRole: "router",
                        isMainGateway: true,
                        parentGateway: null,
                        parentSwitch: null,
                        portCount: 24,
                        history: [
                            {
                                timestamp: historyBaseTime,
                                action: "device_discovered",
                                details: { hostname: "Router-Main", vendor: "Cisco" }
                            },
                            {
                                timestamp: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "name_changed",
                                details: { oldName: "192.168.1.1", newName: "Main Router" }
                            },
                            {
                                timestamp: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "category_assigned",
                                details: { category: "Network Infrastructure" }
                            },
                            {
                                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "role_assigned",
                                details: { role: "router", isMainGateway: true }
                            }
                        ]
                    },
                    "192.168.1.100": {
                        name: "Main File Server",
                        category: "Server",
                        notes: ["Primary file storage", "24/7 operation"],
                        networkRole: "server",
                        isMainGateway: false,
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        portCount: null,
                        history: [
                            {
                                timestamp: historyBaseTime,
                                action: "device_discovered",
                                details: { hostname: "FileServer", vendor: "Dell" }
                            },
                            {
                                timestamp: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "name_changed",
                                details: { oldName: "192.168.1.100", newName: "Main File Server" }
                            },
                            {
                                timestamp: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "category_assigned",
                                details: { category: "Server" }
                            }
                        ]
                    },
                    "192.168.1.50": {
                        name: "Office Switch",
                        category: "Network Infrastructure",
                        notes: ["Main office switch"],
                        networkRole: "switch",
                        isMainGateway: false,
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        portCount: 48,
                        history: [
                            {
                                timestamp: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "device_discovered",
                                details: { hostname: "Switch-01", vendor: "Netgear" }
                            },
                            {
                                timestamp: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                                action: "topology_updated",
                                details: { parentGateway: "192.168.1.1", portCount: 48 }
                            }
                        ]
                    }
                }
            };

            document.getElementById('sampleExportData').innerHTML = `
                <div class="success">
                    <h4>‚úÖ Sample Export Data Generated</h4>
                    <p><strong>Devices:</strong> ${sampleExportData.devices.length}</p>
                    <p><strong>Custom Names:</strong> ${Object.keys(sampleExportData.customNames).length}</p>
                    <p><strong>Total History Entries:</strong> ${sampleExportData.devices.reduce((sum, device) => sum + (device.history ? device.history.length : 0), 0)}</p>
                    <details>
                        <summary>View Sample Data Structure</summary>
                        <pre>${JSON.stringify(sampleExportData, null, 2)}</pre>
                    </details>
                </div>
            `;
        }

        function testImportProcess() {
            if (!sampleExportData) {
                document.getElementById('importResults').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error</h4>
                        <p>Please generate sample export data first.</p>
                    </div>
                `;
                return;
            }

            try {
                // Test the fixed parseJSONImport function
                importedData = parseJSONImport(JSON.stringify(sampleExportData));
                
                let historyPreserved = true;
                let historyResults = [];
                
                // Check each device for history preservation
                Object.keys(importedData.customNames).forEach(ip => {
                    const customName = importedData.customNames[ip];
                    const originalDevice = sampleExportData.devices.find(d => d.ip === ip);
                    const originalCustomName = sampleExportData.customNames[ip];
                    
                    let deviceHistoryCount = 0;
                    let expectedHistoryCount = 0;
                    
                    if (customName.history) {
                        deviceHistoryCount = customName.history.length;
                    }
                    
                    if (originalDevice && originalDevice.history) {
                        expectedHistoryCount = Math.max(expectedHistoryCount, originalDevice.history.length);
                    }
                    
                    if (originalCustomName && originalCustomName.history) {
                        expectedHistoryCount = Math.max(expectedHistoryCount, originalCustomName.history.length);
                    }
                    
                    const isPreserved = deviceHistoryCount >= expectedHistoryCount;
                    if (!isPreserved) historyPreserved = false;
                    
                    historyResults.push({
                        ip: ip,
                        name: customName.name,
                        preserved: isPreserved,
                        imported: deviceHistoryCount,
                        expected: expectedHistoryCount,
                        history: customName.history || []
                    });
                });

                document.getElementById('importResults').innerHTML = `
                    <div class="${historyPreserved ? 'success' : 'error'}">
                        <h4>${historyPreserved ? '‚úÖ' : '‚ùå'} Import Test Results</h4>
                        <p><strong>History Preservation:</strong> ${historyPreserved ? 'SUCCESS' : 'FAILED'}</p>
                        <p><strong>Devices Imported:</strong> ${Object.keys(importedData.customNames).length}</p>
                        
                        <h5>Device History Analysis:</h5>
                        ${historyResults.map(result => `
                            <div class="history-item">
                                <strong>${result.name} (${result.ip})</strong><br>
                                Status: ${result.preserved ? '‚úÖ Preserved' : '‚ùå Lost'}<br>
                                History Entries: ${result.imported}/${result.expected}<br>
                                ${result.history.length > 0 ? `
                                    <details>
                                        <summary>View History (${result.history.length} entries)</summary>
                                        <pre>${JSON.stringify(result.history, null, 2)}</pre>
                                    </details>
                                ` : ''}
                            </div>
                        `).join('')}
                        
                        <details>
                            <summary>View Complete Import Results</summary>
                            <pre>${JSON.stringify(importedData, null, 2)}</pre>
                        </details>
                    </div>
                `;
                
                updateVerificationResults(historyPreserved);
                
            } catch (error) {
                document.getElementById('importResults').innerHTML = `
                    <div class="error">
                        <h4>‚ùå Import Failed</h4>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <pre>${error.stack}</pre>
                    </div>
                `;
                updateVerificationResults(false);
            }
        }

        function testRealFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('realFileResults').innerHTML = `
                    <div class="error">
                        <h4>‚ùå No File Selected</h4>
                        <p>Please select a JSON export file to test.</p>
                    </div>
                `;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const originalData = JSON.parse(fileContent);
                    const importedData = parseJSONImport(fileContent);
                    
                    // Analyze history preservation
                    let totalOriginalHistory = 0;
                    let totalImportedHistory = 0;
                    let devicesWithHistory = 0;
                    let devicesHistoryPreserved = 0;
                    
                    // Count original history entries
                    if (originalData.devices) {
                        originalData.devices.forEach(device => {
                            if (device.history && device.history.length > 0) {
                                totalOriginalHistory += device.history.length;
                                devicesWithHistory++;
                            }
                        });
                    }
                    
                    if (originalData.customNames) {
                        Object.values(originalData.customNames).forEach(customName => {
                            if (customName.history && customName.history.length > 0) {
                                totalOriginalHistory += customName.history.length;
                                devicesWithHistory++;
                            }
                        });
                    }
                    
                    // Count imported history entries
                    if (importedData.customNames) {
                        Object.values(importedData.customNames).forEach(customName => {
                            if (customName.history && customName.history.length > 0) {
                                totalImportedHistory += customName.history.length;
                                devicesHistoryPreserved++;
                            }
                        });
                    }
                    
                    const historyPreservationRate = devicesWithHistory > 0 
                        ? Math.round((devicesHistoryPreserved / devicesWithHistory) * 100)
                        : 100;
                    
                    const isSuccess = historyPreservationRate >= 90; // 90% or better preservation
                    
                    document.getElementById('realFileResults').innerHTML = `
                        <div class="${isSuccess ? 'success' : 'error'}">
                            <h4>${isSuccess ? '‚úÖ' : '‚ùå'} Real File Test Results</h4>
                            <p><strong>File:</strong> ${file.name}</p>
                            <p><strong>Original Devices with History:</strong> ${devicesWithHistory}</p>
                            <p><strong>Imported Devices with History:</strong> ${devicesHistoryPreserved}</p>
                            <p><strong>History Preservation Rate:</strong> ${historyPreservationRate}%</p>
                            <p><strong>Original History Entries:</strong> ${totalOriginalHistory}</p>
                            <p><strong>Imported History Entries:</strong> ${totalImportedHistory}</p>
                            
                            <details>
                                <summary>View Original Data Structure</summary>
                                <pre>${JSON.stringify(originalData, null, 2)}</pre>
                            </details>
                            
                            <details>
                                <summary>View Imported Data Structure</summary>
                                <pre>${JSON.stringify(importedData, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                    
                    updateVerificationResults(isSuccess);
                    
                } catch (error) {
                    document.getElementById('realFileResults').innerHTML = `
                        <div class="error">
                            <h4>‚ùå File Test Failed</h4>
                            <p><strong>Error:</strong> ${error.message}</p>
                            <pre>${error.stack}</pre>
                        </div>
                    `;
                    updateVerificationResults(false);
                }
            };
            reader.readAsText(file);
        }

        function updateVerificationResults(success) {
            const timestamp = new Date().toLocaleString();
            const resultElement = document.getElementById('verificationResults');
            
            const newResult = `
                <div class="${success ? 'success' : 'error'}">
                    <h4>${success ? '‚úÖ' : '‚ùå'} Verification Result</h4>
                    <p><strong>Timestamp:</strong> ${timestamp}</p>
                    <p><strong>Status:</strong> ${success ? 'DEVICE HISTORY PRESERVATION WORKING' : 'DEVICE HISTORY PRESERVATION FAILED'}</p>
                    <p><strong>Fix Status:</strong> ${success ? 'The parseJSONImport fix is working correctly' : 'The parseJSONImport fix needs attention'}</p>
                </div>
            `;
            
            resultElement.innerHTML = newResult + resultElement.innerHTML;
        }

        function clearResults() {
            document.getElementById('sampleExportData').innerHTML = '';
            document.getElementById('importResults').innerHTML = '';
            document.getElementById('realFileResults').innerHTML = '';
            document.getElementById('verificationResults').innerHTML = '';
            sampleExportData = null;
            importedData = null;
        }

        // Auto-generate sample data on page load
        window.onload = function() {
            generateSampleExport();
        };
    </script>
</body>
</html>
