<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Device Save Workflow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        .device {
            background: #374151;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .console {
            background: #111827;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Device Save Workflow</h1>
        <p>This page tests the device save workflow and hierarchy refresh issue.</p>
        
        <button onclick="setupTestDevices()">Setup Test Devices</button>
        <button onclick="testSaveWorkflow()">Test Save Workflow</button>
        <button onclick="clearStorage()">Clear Storage</button>
        <button onclick="viewStorage()">View Storage</button>
        
        <div id="devices"></div>
        
        <h3>Console Output:</h3>
        <div id="console" class="console"></div>
        
        <script>
            let consoleDiv = document.getElementById('console');
            
            function log(message) {
                const timestamp = new Date().toLocaleTimeString();
                consoleDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
                console.log(message);
            }
            
            function setupTestDevices() {
                log('Setting up test devices...');
                
                const testDevices = {
                    "10.5.1.1": {
                        name: "Main Gateway",
                        networkRole: "Gateway",
                        isMainGateway: true,
                        ip: "10.5.1.1",
                        parentGateway: null,
                        parentSwitch: null,
                        connectedGateways: [],
                        connectedSwitches: [],
                        history: []
                    },
                    "10.5.1.10": {
                        name: "Core Switch",
                        networkRole: "Switch", 
                        ip: "10.5.1.10",
                        parentGateway: "10.5.1.1",
                        parentSwitch: null,
                        connectedGateways: ["10.5.1.1"],
                        connectedSwitches: [],
                        history: []
                    },
                    "10.5.1.20": {
                        name: "Test Device 1",
                        networkRole: "Production Server",
                        ip: "10.5.1.20",
                        parentGateway: null,
                        parentSwitch: null,
                        connectedGateways: [],
                        connectedSwitches: [],
                        history: []
                    }
                };
                
                localStorage.setItem("customDeviceProperties", JSON.stringify(testDevices));
                log('Test devices saved to localStorage');
                viewStorage();
            }
            
            function testSaveWorkflow() {
                log('Testing save workflow...');
                
                // Simulate saving Test Device 1 to Core Switch
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                
                if (devices["10.5.1.20"]) {
                    log('Updating Test Device 1 to connect to Core Switch...');
                    
                    devices["10.5.1.20"] = {
                        ...devices["10.5.1.20"],
                        parentSwitch: "10.5.1.10",
                        history: [
                            {
                                timestamp: new Date().toISOString(),
                                changes: {
                                    parentSwitch: "10.5.1.10"
                                }
                            }
                        ]
                    };
                    
                    localStorage.setItem("customDeviceProperties", JSON.stringify(devices));
                    log('Device updated and saved to localStorage');
                    
                    // Trigger a custom event to simulate the save
                    window.dispatchEvent(new CustomEvent('deviceSaved', {
                        detail: devices["10.5.1.20"]
                    }));
                    
                    log('Custom deviceSaved event dispatched');
                    viewStorage();
                } else {
                    log('ERROR: Test Device 1 not found. Run Setup Test Devices first.');
                }
            }
            
            function clearStorage() {
                localStorage.removeItem("customDeviceProperties");
                log('Storage cleared');
                document.getElementById('devices').innerHTML = '';
            }
            
            function viewStorage() {
                const stored = localStorage.getItem("customDeviceProperties");
                if (stored) {
                    const devices = JSON.parse(stored);
                    let html = '<h3>Current Devices in Storage:</h3>';
                    
                    Object.entries(devices).forEach(([ip, device]) => {
                        html += `
                            <div class="device">
                                <strong>${device.name || ip}</strong> (${ip})<br>
                                Role: ${device.networkRole || 'Unknown'}<br>
                                Parent Gateway: ${device.parentGateway || 'None'}<br>
                                Parent Switch: ${device.parentSwitch || 'None'}<br>
                                Connected Gateways: ${(device.connectedGateways || []).join(', ') || 'None'}<br>
                                Connected Switches: ${(device.connectedSwitches || []).join(', ') || 'None'}
                            </div>
                        `;
                    });
                    
                    document.getElementById('devices').innerHTML = html;
                    log(`Found ${Object.keys(devices).length} devices in storage`);
                } else {
                    document.getElementById('devices').innerHTML = '<p>No devices in storage</p>';
                    log('No devices found in storage');
                }
            }
            
            // Listen for deviceSaved events
            window.addEventListener('deviceSaved', (event) => {
                log('Received deviceSaved event: ' + JSON.stringify(event.detail));
            });
            
            // Initialize
            log('Device Save Workflow Test Page Loaded');
            viewStorage();
        </script>
    </div>
</body>
</html>
