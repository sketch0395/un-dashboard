<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Polling Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #2e7d32; }
        .error { background: #d32f2f; }
        .warning { background: #f57c00; }
        .info { background: #1976d2; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .device-list { background: #2a2a2a; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Real-time Device Polling Test</h1>
    
    <div class="status" id="connection-status">Not connected</div>
    
    <div class="device-list">
        <h3>Test Devices:</h3>
        <div id="device-status"></div>
    </div>
    
    <button onclick="connectSocket()">Connect to Server</button>
    <button onclick="addTestDevices()">Add Test Devices</button>
    <button onclick="startPolling()">Start Manual Polling</button>
    <button onclick="stopPolling()">Stop Polling</button>
    
    <div id="logs"></div>
    
    <script>
        // Socket.IO will be loaded from the server
        let socket = null;
        let pollingInterval = null;
        
        // Test devices
        const testDevices = [
            { ip: '127.0.0.1', name: 'Localhost' },
            { ip: '8.8.8.8', name: 'Google DNS' },
            { ip: '1.1.1.1', name: 'Cloudflare DNS' }
        ];
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateConnectionStatus(status, type = 'info') {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = status;
            statusEl.className = `status ${type}`;
        }
        
        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }
            
            log('Attempting to connect to Socket.IO server at localhost:4000');
            updateConnectionStatus('Connecting...', 'warning');
            
            // Load Socket.IO from server
            const script = document.createElement('script');
            script.src = 'http://localhost:4000/socket.io/socket.io.js';
            script.onload = () => {
                log('Socket.IO script loaded successfully');
                initializeSocket();
            };
            script.onerror = () => {
                log('Failed to load Socket.IO script from server', 'error');
                updateConnectionStatus('Failed to load Socket.IO', 'error');
            };
            document.head.appendChild(script);
        }
        
        function initializeSocket() {
            socket = io('http://localhost:4000', {
                transports: ['polling', 'websocket'],
                timeout: 10000
            });
            
            socket.on('connect', () => {
                log('Connected to server successfully!', 'success');
                updateConnectionStatus(`Connected (ID: ${socket.id})`, 'success');
                displayDevices();
            });
            
            socket.on('disconnect', (reason) => {
                log(`Disconnected: ${reason}`, 'warning');
                updateConnectionStatus('Disconnected', 'error');
            });
            
            socket.on('connect_error', (error) => {
                log(`Connection error: ${error.message}`, 'error');
                updateConnectionStatus('Connection failed', 'error');
            });
            
            socket.on('deviceStatusUpdate', (data) => {
                log(`Received status update for ${data.results?.length || 0} devices`, 'success');
                updateDeviceStatus(data.results);
            });
            
            socket.on('deviceStatusError', (error) => {
                log(`Device status error: ${error.error}`, 'error');
            });
        }
        
        function addTestDevices() {
            // Add devices to localStorage (for Device Management page compatibility)
            const deviceProps = {};
            testDevices.forEach(device => {
                deviceProps[device.ip] = {
                    name: device.name,
                    category: 'Test Device',
                    networkRole: null,
                    notes: [],
                    history: []
                };
            });
            
            localStorage.setItem('customDeviceProperties', JSON.stringify(deviceProps));
            log('Added test devices to localStorage', 'success');
            displayDevices();
        }
        
        function displayDevices() {
            const deviceStatus = document.getElementById('device-status');
            deviceStatus.innerHTML = '';
            
            testDevices.forEach(device => {
                const div = document.createElement('div');
                div.id = `device-${device.ip.replace(/\\./g, '-')}`;
                div.innerHTML = `<strong>${device.name}</strong> (${device.ip}): <span class="status info">Unknown</span>`;
                deviceStatus.appendChild(div);
            });
        }
        
        function updateDeviceStatus(results) {
            if (!results) return;
            
            results.forEach(result => {
                const deviceEl = document.getElementById(`device-${result.ip.replace(/\\./g, '-')}`);
                if (deviceEl) {
                    const statusText = result.alive ? 
                        `✅ Online (${result.latency}ms)` : 
                        '❌ Offline';
                    const statusClass = result.alive ? 'success' : 'error';
                    
                    deviceEl.innerHTML = deviceEl.innerHTML.replace(
                        /<span class="status \\w+">.*?<\\/span>/, 
                        `<span class="status ${statusClass}">${statusText}</span>`
                    );
                }
            });
        }
        
        function startPolling() {
            if (!socket || !socket.connected) {
                log('Socket not connected. Please connect first.', 'error');
                return;
            }
            
            if (pollingInterval) {
                log('Polling already active', 'warning');
                return;
            }
            
            function poll() {
                const ips = testDevices.map(d => d.ip);
                log(`Polling ${ips.length} devices: ${ips.join(', ')}`);
                
                socket.emit('pollDeviceStatus', {
                    ips: ips,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Initial poll
            poll();
            
            // Set up interval polling every 30 seconds for testing
            pollingInterval = setInterval(poll, 30000);
            log('Started automatic polling every 30 seconds', 'success');
        }
        
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                log('Stopped automatic polling', 'warning');
            } else {
                log('No active polling to stop', 'info');
            }
        }
        
        // Auto-initialize
        window.onload = () => {
            displayDevices();
            log('Page loaded. Click "Connect to Server" to begin testing.');
        };
    </script>
</body>
</html>
