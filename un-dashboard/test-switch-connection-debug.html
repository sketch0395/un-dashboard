<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Connection Debug & Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section h2 {
            color: #333;
            margin-top: 0;
        }
        .step {
            background: #f5f5f5;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007acc;
        }
        .result {
            background: #e8f5e8;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
        .warning {
            background: #fff3cd;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
        }
        .error {
            background: #f8d7da;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .test-data {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }
        .status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>Switch Connection Debug & Fix Tool</h1>
    <p>This tool diagnoses and fixes issues with devices not connecting to switches.</p>

    <div class="test-section">
        <h2>Connection Issue Diagnosis</h2>
        <div class="step">
            <strong>Step 1:</strong> Analyze current device connections
            <button onclick="analyzeConnections()">Analyze Connections</button>
            <div id="analysisResults" class="test-data"></div>
        </div>
        <div class="step">
            <strong>Step 2:</strong> Identify connection problems
            <button onclick="identifyProblems()">Identify Problems</button>
            <div id="problemResults" class="test-data"></div>
        </div>
        <div class="step">
            <strong>Step 3:</strong> Create test environment with proper connections
            <button onclick="createTestEnvironment()">Create Test Environment</button>
            <div id="testEnvResults" class="test-data"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>Connection Fixes</h2>
        <div class="step">
            <strong>Fix 1:</strong> Auto-connect orphaned devices to switches
            <button onclick="autoConnectDevices()">Auto-Connect Devices</button>
            <div id="autoConnectResults" class="test-data"></div>
        </div>
        <div class="step">
            <strong>Fix 2:</strong> Repair broken switch references
            <button onclick="repairSwitchReferences()">Repair References</button>
            <div id="repairResults" class="test-data"></div>
        </div>
        <div class="step">
            <strong>Fix 3:</strong> Validate and fix parent-child relationships
            <button onclick="validateRelationships()">Validate Relationships</button>
            <div id="validateResults" class="test-data"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>Manual Testing</h2>
        <div class="step">
            <strong>Manual Test:</strong> Open application to verify fixes
            <button onclick="openApplication()">Open Application</button>
            <div class="warning">
                <strong>Manual Verification Steps:</strong>
                <ol>
                    <li>Open the application and navigate to Device Management</li>
                    <li>Look for devices that should be connected to switches</li>
                    <li>Click on a regular device to edit it</li>
                    <li>Check the "Connected to Switch" dropdown - it should show available switches</li>
                    <li>Try connecting a device to a switch and save</li>
                    <li>Verify the connection appears in the network topology view</li>
                    <li>Check that switch devices can connect to gateways</li>
                </ol>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Results Summary</h2>
        <div id="summary" class="test-data"></div>
    </div>

    <script>
        let currentData = null;
        let issues = [];
        let fixes = [];

        function log(message, type = 'info') {
            console.log(message);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            // You can extend this to show in UI if needed
            return logEntry;
        }

        function analyzeConnections() {
            try {
                // Get current device data
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                const scannedDevices = JSON.parse(localStorage.getItem("scannedDevices") || "{}");
                
                currentData = { devices, scannedDevices };
                
                // Analyze connection patterns
                const analysis = {
                    totalDevices: Object.keys(devices).length,
                    switches: [],
                    gateways: [],
                    regularDevices: [],
                    connectionsToSwitches: 0,
                    connectionsToGateways: 0,
                    orphanedDevices: 0
                };

                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.networkRole === 'switch' || device.networkRole === 'Switch') {
                        analysis.switches.push({
                            ip,
                            name: device.name || ip,
                            connectedDevices: []
                        });
                    } else if (device.networkRole === 'gateway' || device.networkRole === 'Gateway') {
                        analysis.gateways.push({
                            ip,
                            name: device.name || ip,
                            isMain: device.isMainGateway || false,
                            connectedDevices: []
                        });
                    } else {
                        const hasParentSwitch = device.parentSwitch && device.parentSwitch.trim() !== '';
                        const hasParentGateway = device.parentGateway && device.parentGateway.trim() !== '';
                        
                        analysis.regularDevices.push({
                            ip,
                            name: device.name || ip,
                            parentSwitch: device.parentSwitch || null,
                            parentGateway: device.parentGateway || null,
                            hasConnection: hasParentSwitch || hasParentGateway
                        });

                        if (hasParentSwitch) analysis.connectionsToSwitches++;
                        if (hasParentGateway) analysis.connectionsToGateways++;
                        if (!hasParentSwitch && !hasParentGateway) analysis.orphanedDevices++;
                    }
                });

                // Find which devices are connected to which switches/gateways
                analysis.switches.forEach(switchDevice => {
                    switchDevice.connectedDevices = analysis.regularDevices.filter(device => 
                        device.parentSwitch === switchDevice.ip
                    );
                });

                analysis.gateways.forEach(gatewayDevice => {
                    gatewayDevice.connectedDevices = analysis.regularDevices.filter(device => 
                        device.parentGateway === gatewayDevice.ip
                    );
                });

                document.getElementById('analysisResults').innerHTML = `
                    <h3>Connection Analysis Results:</h3>
                    <div class="code">${JSON.stringify(analysis, null, 2)}</div>
                    
                    <h4>Summary:</h4>
                    <ul>
                        <li><strong>Total Devices:</strong> ${analysis.totalDevices}</li>
                        <li><strong>Switches:</strong> ${analysis.switches.length}</li>
                        <li><strong>Gateways:</strong> ${analysis.gateways.length}</li>
                        <li><strong>Regular Devices:</strong> ${analysis.regularDevices.length}</li>
                        <li><strong>Devices connected to switches:</strong> ${analysis.connectionsToSwitches}</li>
                        <li><strong>Devices connected to gateways:</strong> ${analysis.connectionsToGateways}</li>
                        <li><strong>Orphaned devices:</strong> ${analysis.orphanedDevices}</li>
                    </ul>
                `;

                log('Connection analysis completed');
            } catch (error) {
                document.getElementById('analysisResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Analysis error:', error);
            }
        }

        function identifyProblems() {
            if (!currentData) {
                document.getElementById('problemResults').innerHTML = '<div class="warning">Run connection analysis first</div>';
                return;
            }

            try {
                issues = [];
                const { devices } = currentData;

                // Problem 1: Devices referencing non-existent switches
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.parentSwitch && device.parentSwitch.trim() !== '') {
                        if (!devices[device.parentSwitch]) {
                            issues.push({
                                type: 'missing_switch',
                                device: ip,
                                deviceName: device.name || ip,
                                issue: `Device references non-existent switch: ${device.parentSwitch}`,
                                severity: 'high'
                            });
                        } else if (devices[device.parentSwitch].networkRole !== 'switch' && 
                                  devices[device.parentSwitch].networkRole !== 'Switch') {
                            issues.push({
                                type: 'invalid_switch_role',
                                device: ip,
                                deviceName: device.name || ip,
                                issue: `Device references a non-switch device as parent switch: ${device.parentSwitch}`,
                                severity: 'high'
                            });
                        }
                    }
                });

                // Problem 2: Switches with no gateway connections
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.networkRole === 'switch' || device.networkRole === 'Switch') {
                        const hasGatewayConnection = 
                            (device.parentGateway && device.parentGateway.trim() !== '') ||
                            (Array.isArray(device.connectedGateways) && device.connectedGateways.length > 0);
                        
                        if (!hasGatewayConnection) {
                            issues.push({
                                type: 'switch_no_gateway',
                                device: ip,
                                deviceName: device.name || ip,
                                issue: 'Switch has no gateway connection',
                                severity: 'medium'
                            });
                        }
                    }
                });

                // Problem 3: Regular devices with no switch connections when switches exist
                const availableSwitches = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'switch' || device.networkRole === 'Switch'
                );

                if (availableSwitches.length > 0) {
                    Object.entries(devices).forEach(([ip, device]) => {
                        if (!device.networkRole) { // Regular device
                            const hasConnection = 
                                (device.parentSwitch && device.parentSwitch.trim() !== '') ||
                                (device.parentGateway && device.parentGateway.trim() !== '');
                            
                            if (!hasConnection) {
                                issues.push({
                                    type: 'orphaned_device',
                                    device: ip,
                                    deviceName: device.name || ip,
                                    issue: 'Device has no switch or gateway connection',
                                    severity: 'low'
                                });
                            }
                        }
                    });
                }

                document.getElementById('problemResults').innerHTML = `
                    <h3>Identified Problems (${issues.length}):</h3>
                    ${issues.map((issue, index) => `
                        <div class="error">
                            <strong>${index + 1}. ${issue.severity.toUpperCase()}</strong><br>
                            <strong>Device:</strong> ${issue.deviceName} (${issue.device})<br>
                            <strong>Issue:</strong> ${issue.issue}<br>
                            <strong>Type:</strong> ${issue.type}
                        </div>
                    `).join('')}
                    
                    ${issues.length === 0 ? '<div class="result">No connection problems found!</div>' : ''}
                `;

                log(`Identified ${issues.length} connection problems`);
            } catch (error) {
                document.getElementById('problemResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Problem identification error:', error);
            }
        }

        function createTestEnvironment() {
            try {
                // Create a test environment with proper switch connections
                const testDevices = {
                    "192.168.1.1": {
                        name: "Main Gateway",
                        networkRole: "gateway",
                        isMainGateway: true,
                        parentGateway: null,
                        parentSwitch: null,
                        connectedGateways: [],
                        connectedSwitches: [],
                        category: "Network Infrastructure",
                        notes: []
                    },
                    "192.168.1.10": {
                        name: "Core Switch",
                        networkRole: "switch",
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        connectedGateways: ["192.168.1.1"],
                        connectedSwitches: [],
                        category: "Network Infrastructure",
                        notes: []
                    },
                    "192.168.1.11": {
                        name: "Access Switch 1",
                        networkRole: "switch",
                        parentGateway: "192.168.1.1",
                        parentSwitch: null,
                        connectedGateways: ["192.168.1.1"],
                        connectedSwitches: [],
                        category: "Network Infrastructure",
                        notes: []
                    },
                    "192.168.1.20": {
                        name: "Workstation 1",
                        networkRole: null,
                        parentGateway: null,
                        parentSwitch: "192.168.1.10",
                        connectedGateways: [],
                        connectedSwitches: [],
                        category: "Workstation",
                        notes: []
                    },
                    "192.168.1.21": {
                        name: "Workstation 2",
                        networkRole: null,
                        parentGateway: null,
                        parentSwitch: "192.168.1.11",
                        connectedGateways: [],
                        connectedSwitches: [],
                        category: "Workstation",
                        notes: []
                    },
                    "192.168.1.30": {
                        name: "Server 1",
                        networkRole: null,
                        parentGateway: null,
                        parentSwitch: "192.168.1.10",
                        connectedGateways: [],
                        connectedSwitches: [],
                        category: "Server",
                        notes: []
                    }
                };

                // Save test environment
                localStorage.setItem("customDeviceProperties", JSON.stringify(testDevices));
                
                document.getElementById('testEnvResults').innerHTML = `
                    <h3>Test Environment Created:</h3>
                    <div class="result">
                        <p>Created a test network with:</p>
                        <ul>
                            <li>1 Main Gateway (192.168.1.1)</li>
                            <li>2 Switches connected to gateway (192.168.1.10, 192.168.1.11)</li>
                            <li>3 Regular devices connected to switches</li>
                        </ul>
                        <p><strong>This environment shows how switch connections should work.</strong></p>
                    </div>
                    
                    <h4>Test Environment Details:</h4>
                    <div class="code">${JSON.stringify(testDevices, null, 2)}</div>
                `;

                log('Test environment created successfully');
            } catch (error) {
                document.getElementById('testEnvResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Test environment error:', error);
            }
        }

        function autoConnectDevices() {
            if (!currentData) {
                document.getElementById('autoConnectResults').innerHTML = '<div class="warning">Run connection analysis first</div>';
                return;
            }

            try {
                fixes = [];
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                
                // Find available switches
                const availableSwitches = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'switch' || device.networkRole === 'Switch'
                );

                if (availableSwitches.length === 0) {
                    document.getElementById('autoConnectResults').innerHTML = 
                        '<div class="warning">No switches available to connect devices to</div>';
                    return;
                }

                // Auto-connect orphaned regular devices to the first available switch
                Object.entries(devices).forEach(([ip, device]) => {
                    if (!device.networkRole) { // Regular device
                        const hasConnection = 
                            (device.parentSwitch && device.parentSwitch.trim() !== '') ||
                            (device.parentGateway && device.parentGateway.trim() !== '');
                        
                        if (!hasConnection) {
                            const targetSwitch = availableSwitches[0];
                            devices[ip] = {
                                ...device,
                                parentSwitch: targetSwitch[0],
                                parentGateway: null // Clear any invalid gateway connection
                            };
                            
                            fixes.push({
                                type: 'auto_connect',
                                device: ip,
                                deviceName: device.name || ip,
                                action: `Connected to switch ${targetSwitch[1].name || targetSwitch[0]}`
                            });
                        }
                    }
                });

                // Save the fixes
                localStorage.setItem("customDeviceProperties", JSON.stringify(devices));

                document.getElementById('autoConnectResults').innerHTML = `
                    <h3>Auto-Connect Results (${fixes.length} fixes):</h3>
                    ${fixes.map((fix, index) => `
                        <div class="result">
                            <strong>${index + 1}.</strong> ${fix.deviceName} (${fix.device})<br>
                            <strong>Action:</strong> ${fix.action}
                        </div>
                    `).join('')}
                    
                    ${fixes.length === 0 ? '<div class="result">No devices needed auto-connection</div>' : ''}
                `;

                log(`Auto-connected ${fixes.length} devices`);
            } catch (error) {
                document.getElementById('autoConnectResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Auto-connect error:', error);
            }
        }

        function repairSwitchReferences() {
            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                let repairs = [];

                // Fix 1: Remove references to non-existent switches
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.parentSwitch && device.parentSwitch.trim() !== '') {
                        if (!devices[device.parentSwitch]) {
                            devices[ip] = {
                                ...device,
                                parentSwitch: null
                            };
                            repairs.push({
                                type: 'remove_invalid_switch',
                                device: ip,
                                deviceName: device.name || ip,
                                action: `Removed reference to non-existent switch ${device.parentSwitch}`
                            });
                        }
                    }
                });

                // Fix 2: Remove references to devices that aren't switches
                Object.entries(devices).forEach(([ip, device]) => {
                    if (device.parentSwitch && device.parentSwitch.trim() !== '') {
                        const parentDevice = devices[device.parentSwitch];
                        if (parentDevice && parentDevice.networkRole !== 'switch' && parentDevice.networkRole !== 'Switch') {
                            devices[ip] = {
                                ...device,
                                parentSwitch: null
                            };
                            repairs.push({
                                type: 'remove_non_switch_parent',
                                device: ip,
                                deviceName: device.name || ip,
                                action: `Removed reference to non-switch device ${device.parentSwitch}`
                            });
                        }
                    }
                });

                // Save repairs
                localStorage.setItem("customDeviceProperties", JSON.stringify(devices));

                document.getElementById('repairResults').innerHTML = `
                    <h3>Switch Reference Repairs (${repairs.length} fixes):</h3>
                    ${repairs.map((repair, index) => `
                        <div class="result">
                            <strong>${index + 1}.</strong> ${repair.deviceName} (${repair.device})<br>
                            <strong>Action:</strong> ${repair.action}
                        </div>
                    `).join('')}
                    
                    ${repairs.length === 0 ? '<div class="result">No switch reference repairs needed</div>' : ''}
                `;

                log(`Repaired ${repairs.length} switch references`);
            } catch (error) {
                document.getElementById('repairResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Repair error:', error);
            }
        }

        function validateRelationships() {
            try {
                const devices = JSON.parse(localStorage.getItem("customDeviceProperties") || "{}");
                let validations = [];

                // Validation 1: Ensure switches have gateway connections
                const availableGateways = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'gateway' || device.networkRole === 'Gateway'
                );

                if (availableGateways.length > 0) {
                    Object.entries(devices).forEach(([ip, device]) => {
                        if (device.networkRole === 'switch' || device.networkRole === 'Switch') {
                            const hasGatewayConnection = 
                                (device.parentGateway && device.parentGateway.trim() !== '') ||
                                (Array.isArray(device.connectedGateways) && device.connectedGateways.length > 0);
                            
                            if (!hasGatewayConnection) {
                                const primaryGateway = availableGateways[0];
                                devices[ip] = {
                                    ...device,
                                    parentGateway: primaryGateway[0],
                                    connectedGateways: [primaryGateway[0]]
                                };
                                
                                validations.push({
                                    type: 'connect_switch_to_gateway',
                                    device: ip,
                                    deviceName: device.name || ip,
                                    action: `Connected switch to gateway ${primaryGateway[1].name || primaryGateway[0]}`
                                });
                            }
                        }
                    });
                }

                // Validation 2: Ensure regular devices prefer switch connections over direct gateway connections
                const availableSwitches = Object.entries(devices).filter(([_, device]) => 
                    device.networkRole === 'switch' || device.networkRole === 'Switch'
                );

                if (availableSwitches.length > 0) {
                    Object.entries(devices).forEach(([ip, device]) => {
                        if (!device.networkRole) { // Regular device
                            // If device is connected to gateway but switches are available, suggest switch connection
                            if (device.parentGateway && !device.parentSwitch) {
                                validations.push({
                                    type: 'suggest_switch_over_gateway',
                                    device: ip,
                                    deviceName: device.name || ip,
                                    action: `Consider connecting to switch instead of direct gateway connection`,
                                    severity: 'suggestion'
                                });
                            }
                        }
                    });
                }

                // Save validations
                localStorage.setItem("customDeviceProperties", JSON.stringify(devices));

                document.getElementById('validateResults').innerHTML = `
                    <h3>Relationship Validation (${validations.length} actions):</h3>
                    ${validations.map((validation, index) => `
                        <div class="${validation.severity === 'suggestion' ? 'warning' : 'result'}">
                            <strong>${index + 1}.</strong> ${validation.deviceName} (${validation.device})<br>
                            <strong>Action:</strong> ${validation.action}
                        </div>
                    `).join('')}
                    
                    ${validations.length === 0 ? '<div class="result">All relationships are valid</div>' : ''}
                `;

                log(`Performed ${validations.length} relationship validations`);
            } catch (error) {
                document.getElementById('validateResults').innerHTML = `<div class="error">Error: ${error.message}</div>`;
                console.error('Validation error:', error);
            }
        }

        function openApplication() {
            window.open('http://localhost:3000', '_blank');
            log('Application opened for manual testing');
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <h3>Debug Session Summary:</h3>
                <p><strong>Issues Identified:</strong> ${issues.length}</p>
                <p><strong>Fixes Applied:</strong> ${fixes.length}</p>
                <p><strong>Status:</strong> ${issues.length === 0 ? 'All good!' : 'Issues found and fixes applied'}</p>
                
                <h4>Common Switch Connection Issues:</h4>
                <ul>
                    <li><strong>Missing Switch Role:</strong> Devices need to be marked as "Switch" in their network role</li>
                    <li><strong>Invalid References:</strong> Devices pointing to non-existent or non-switch devices</li>
                    <li><strong>No Gateway Connection:</strong> Switches should be connected to gateways</li>
                    <li><strong>Orphaned Devices:</strong> Regular devices not connected to any network infrastructure</li>
                </ul>
                
                <h4>Best Practices:</h4>
                <ul>
                    <li>Create gateway devices first (mark as "Gateway" and set as main gateway)</li>
                    <li>Create switch devices and connect them to gateways</li>
                    <li>Connect regular devices to switches (not directly to gateways)</li>
                    <li>Use the device modal to set proper network roles and connections</li>
                </ul>
            `;
        }

        // Initialize
        updateSummary();
    </script>
</body>
</html>
